<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn PDF Uploader | BigOil.net</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary: #0077B5;
            --primary-dark: #005a8c;
            --secondary: #00A0DC;
            --accent: #c9a227;
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-input: #16213e;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0b0;
            --border-color: #2a2a3a;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: white;
        }

        .header-logo svg {
            width: 32px;
            height: 32px;
        }

        .header-logo span {
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            gap: 20px;
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .header-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 36px;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .upload-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(0, 119, 181, 0.1);
        }

        .drop-zone.processing {
            border-color: var(--accent);
            background: rgba(201, 162, 39, 0.1);
        }

        .drop-zone svg {
            width: 64px;
            height: 64px;
            color: var(--secondary);
            margin-bottom: 20px;
        }

        .drop-zone h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .drop-zone p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .drop-zone input {
            display: none;
        }

        .progress-container {
            margin-top: 30px;
            display: none;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        .status {
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.visible {
            display: block;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .status.info {
            background: rgba(0, 119, 181, 0.1);
            border: 1px solid var(--primary);
            color: var(--secondary);
        }

        .results-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-section h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .results-table td {
            font-size: 14px;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .badge.pending {
            background: rgba(201, 162, 39, 0.2);
            color: var(--accent);
        }

        .stats {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: 'Oswald', sans-serif;
            font-size: 36px;
            color: var(--secondary);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            margin-bottom: 20px;
        }

        .btn-primary, .btn-secondary {
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: var(--bg-input);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .bookmarklet-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .bookmarklet-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .bookmarklet-section p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .bookmarklet-section .hint {
            margin-top: 15px;
            font-size: 13px;
        }

        .bookmarklet {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .bookmarklet:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 119, 181, 0.4);
        }

        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 30px 0;
            position: relative;
        }

        .divider::after {
            content: 'or';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            padding: 0 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .drop-section h3 {
            text-align: center;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .drop-zone {
            padding: 30px 20px;
        }

        .drop-zone svg {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
        }

        .instructions-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .instructions-section h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            margin-bottom: 25px;
            text-align: center;
        }

        .steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .step {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .step-num {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .step-content p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .footer {
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 40px;
        }

        .footer a {
            color: var(--secondary);
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
            }

            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 28px;
            }

            .upload-section {
                padding: 20px;
            }

            .drop-zone {
                padding: 40px 20px;
            }

            .stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="header-logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Profile Collector</span>
        </a>
        <nav class="header-nav">
            <a href="index.html">Home</a>
            <a href="candidate-analyzer.html">Candidate Analyzer</a>
            <a href="linkedin-downloader.html">Extension</a>
        </nav>
    </header>

    <div class="container">
        <h1>LinkedIn Profile Collector</h1>
        <p class="subtitle">Use the bookmarklet to capture profiles, then download as CSV</p>

        <div class="upload-section">
            <div class="bookmarklet-section">
                <h3>Step 1: Add Bookmarklet</h3>
                <p>Drag this button to your bookmarks bar:</p>
                <a class="bookmarklet" id="bookmarklet" href="#">Capture LinkedIn</a>
                <p class="hint">Then click it on any LinkedIn profile page to capture</p>
            </div>

            <div class="divider"></div>

            <div class="drop-section">
                <h3>Or: Drop PDFs</h3>
                <div class="drop-zone" id="dropZone">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p>Drop LinkedIn PDFs here</p>
                    <input type="file" id="fileInput" multiple accept=".pdf">
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Processing...</div>
            </div>

            <div class="status" id="status"></div>
        </div>

        <div class="instructions-section">
            <h2>How to Use</h2>
            <div class="steps">
                <div class="step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <h4>Add the Bookmarklet</h4>
                        <p>Drag the blue "Capture LinkedIn" button above to your bookmarks bar. You only do this once.</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <h4>Capture Profiles</h4>
                        <p>Go to any LinkedIn profile or Recruiter page and click the bookmark. You'll see a green confirmation.</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <h4>Download CSV</h4>
                        <p>Come back here to see all captured profiles, then click "Download CSV" to export.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>Collected Profiles</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Title</th>
                        <th>Company</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>

            <div class="actions">
                <button class="btn-primary" id="downloadCsvBtn" disabled>Download CSV</button>
                <button class="btn-secondary" id="clearBtn">Clear All</button>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="profileCount">0</div>
                    <div class="stat-label">Profiles Ready</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Part of the <a href="index.html">BigOil.net</a> Recruitment Tools Suite</p>
    </footer>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Storage key
        const STORAGE_KEY = 'linkedinProfiles';

        // Load profiles from localStorage
        let profiles = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        // Bookmarklet code - handles both Recruiter and public profiles
        const bookmarkletCode = `javascript:(function(){
            var host=location.hostname;
            var path=location.pathname;

            if(!host.includes('linkedin.com')){
                alert('Please use this on LinkedIn');return;
            }

            /* RECRUITER PAGE - find public profile link and open it */
            if(path.includes('/talent/') || path.includes('/recruiter/')){
                var pubLink=null;
                /* Look for public profile link */
                var links=document.querySelectorAll('a[href*="/in/"]');
                for(var i=0;i<links.length;i++){
                    var href=links[i].getAttribute('href');
                    if(href && href.match(/\\/in\\/[a-zA-Z0-9-]+/)){
                        pubLink=href;break;
                    }
                }
                if(!pubLink){
                    /* Try looking for "View public profile" or similar */
                    var btns=document.querySelectorAll('a,button');
                    for(var i=0;i<btns.length;i++){
                        var txt=btns[i].textContent.toLowerCase();
                        if(txt.includes('public profile')||txt.includes('view profile')){
                            var h=btns[i].getAttribute('href');
                            if(h&&h.includes('/in/')){pubLink=h;break;}
                        }
                    }
                }
                if(pubLink){
                    var fullUrl=pubLink.startsWith('http')?pubLink:'https://www.linkedin.com'+pubLink;
                    /* Add param to trigger auto-capture */
                    fullUrl+=(fullUrl.includes('?')?'&':'?')+'autocapture=1';
                    window.open(fullUrl,'_blank');
                    var n=document.createElement('div');
                    n.innerHTML='Opening public profile...';
                    n.style.cssText='position:fixed;top:20px;right:20px;z-index:999999;padding:16px 24px;border-radius:8px;font-family:system-ui;font-size:14px;font-weight:600;color:white;box-shadow:0 4px 12px rgba(0,0,0,0.3);background:#3b82f6';
                    document.body.appendChild(n);
                    setTimeout(function(){n.remove();},2000);
                }else{
                    alert('Could not find public profile link. Try clicking on their name first.');
                }
                return;
            }

            /* PUBLIC PROFILE PAGE - scrape and save */
            if(!path.startsWith('/in/')){
                alert('Please use on a LinkedIn profile or Recruiter page');return;
            }

            var d={
                first_name:'',last_name:'',full_name:'',linkedin_link:location.href.split('?')[0],
                headline:'',title:'',company:'',location:'',school:'',skills:'',experience:'',
                captured_at:new Date().toISOString()
            };
            var h1=document.querySelector('h1');
            if(h1){
                d.full_name=h1.textContent.trim();
                var p=d.full_name.split(' ');
                d.first_name=p[0]||'';
                d.last_name=p.slice(1).join(' ')||'';
            }
            var hl=document.querySelector('div.text-body-medium');
            if(hl){
                d.headline=hl.textContent.trim();
                var m=d.headline.match(/^(.+?)\\s*[@|at]\\s*(.+?)(?:\\s*\\||$)/i);
                if(m){d.title=m[1].trim();d.company=m[2].trim();}
            }
            var loc=document.querySelector('span.text-body-small.inline.t-black--light.break-words');
            if(loc)d.location=loc.textContent.trim();
            var exp=document.getElementById('experience');
            if(exp){
                var sec=exp.closest('section');
                if(sec){
                    var jobs=[];
                    sec.querySelectorAll('li').forEach(function(li,i){
                        if(i>=3)return;
                        var t=li.querySelector('span[aria-hidden="true"]');
                        if(t)jobs.push(t.textContent.trim());
                    });
                    d.experience=jobs.join(' | ');
                }
            }
            var edu=document.getElementById('education');
            if(edu){
                var sec=edu.closest('section');
                if(sec){
                    var t=sec.querySelector('span[aria-hidden="true"]');
                    if(t)d.school=t.textContent.trim();
                }
            }
            var sk=document.getElementById('skills');
            if(sk){
                var sec=sk.closest('section');
                if(sec){
                    var skills=[];
                    sec.querySelectorAll('li span[aria-hidden="true"]').forEach(function(s,i){
                        if(i>=5)return;
                        skills.push(s.textContent.trim());
                    });
                    d.skills=skills.join(', ');
                }
            }
            var saved=JSON.parse(localStorage.getItem('linkedinProfiles')||'[]');
            var exists=saved.some(function(p){return p.linkedin_link===d.linkedin_link;});
            if(!exists){saved.push(d);localStorage.setItem('linkedinProfiles',JSON.stringify(saved));}
            var n=document.createElement('div');
            n.innerHTML=(exists?'Already captured: ':'Captured: ')+d.full_name;
            n.style.cssText='position:fixed;top:20px;right:20px;z-index:999999;padding:16px 24px;border-radius:8px;font-family:system-ui;font-size:14px;font-weight:600;color:white;box-shadow:0 4px 12px rgba(0,0,0,0.3);background:'+(exists?'#f59e0b':'#10b981');
            document.body.appendChild(n);
            setTimeout(function(){n.remove();},3000);

            /* If opened with autocapture param, close after capture */
            if(location.search.includes('autocapture=1')){
                setTimeout(function(){window.close();},1500);
            }
        })();`;

        // Set bookmarklet href
        document.getElementById('bookmarklet').href = bookmarkletCode;

        // DOM elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusEl = document.getElementById('status');
        const resultsSection = document.getElementById('resultsSection');
        const resultsBody = document.getElementById('resultsBody');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const clearBtn = document.getElementById('clearBtn');
        const profileCount = document.getElementById('profileCount');

        // Load existing profiles on page load
        if (profiles.length > 0) {
            resultsSection.classList.add('visible');
            profiles.forEach(p => addResultRow(p));
            updateUI();
        }

        // Listen for storage changes (from bookmarklet in other tabs)
        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_KEY) {
                profiles = JSON.parse(e.newValue || '[]');
                resultsBody.innerHTML = '';
                profiles.forEach(p => addResultRow(p));
                resultsSection.classList.add('visible');
                updateUI();
                showStatus('New profile captured!', 'success');
            }
        });

        // Event listeners
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        downloadCsvBtn.addEventListener('click', downloadCSV);
        clearBtn.addEventListener('click', clearAll);

        async function handleFiles(files) {
            const pdfFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.endsWith('.pdf'));

            if (pdfFiles.length === 0) {
                showStatus('Please select PDF files', 'error');
                return;
            }

            dropZone.classList.add('processing');
            progressContainer.classList.add('visible');
            resultsSection.classList.add('visible');

            let successCount = 0;

            for (let i = 0; i < pdfFiles.length; i++) {
                const file = pdfFiles[i];
                const progress = Math.round(((i + 1) / pdfFiles.length) * 100);
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Processing ${i + 1}/${pdfFiles.length}: ${file.name}`;

                try {
                    const data = await parsePDF(file);
                    // Check for duplicates
                    const exists = profiles.some(p => p.linkedin_link === data.linkedin_link);
                    if (!exists) {
                        profiles.push(data);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(profiles));
                        addResultRow(data);
                        successCount++;
                    }
                } catch (err) {
                    console.error('Error processing', file.name, err);
                    showStatus(`Error: ${err.message}`, 'error');
                }
            }

            updateUI();
            dropZone.classList.remove('processing');
            progressContainer.classList.remove('visible');
            progressFill.style.width = '0%';

            showStatus(`Parsed ${successCount}/${pdfFiles.length} profiles. Click "Download CSV" to export.`, 'success');
        }

        function updateUI() {
            profileCount.textContent = profiles.length;
            downloadCsvBtn.disabled = profiles.length === 0;
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                let lastY = null;
                for (const item of textContent.items) {
                    if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                        fullText += '\n';
                    }
                    fullText += item.str + ' ';
                    lastY = item.transform[5];
                }
                fullText += '\n';
            }

            return extractLinkedInData(fullText, file.name);
        }

        function extractLinkedInData(text, filename) {
            const data = {
                first_name: '', last_name: '', full_name: '', linkedin_link: '',
                headline: '', title: '', company: '', location: '',
                school: '', degree: '', skills: '', experience: '',
                source_file: filename, parsed_at: new Date().toISOString()
            };

            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // LinkedIn URL
            const urlMatch = text.match(/linkedin\.com\/in\/([a-zA-Z0-9\-]+)/);
            if (urlMatch) data.linkedin_link = `https://www.linkedin.com/in/${urlMatch[1]}`;

            // Find section indices
            let expIdx = lines.findIndex(l => l === 'Experience');
            let eduIdx = lines.findIndex(l => l === 'Education');
            let skillsIdx = lines.findIndex(l => l === 'Top Skills' || l === 'Skills');
            let summaryIdx = lines.findIndex(l => l === 'Summary');
            let contactIdx = lines.findIndex(l => l === 'Contact');

            const sectionHeaders = [
                'Summary', 'Experience', 'Education', 'Skills', 'Contact', 'Page', 'LinkedIn',
                'Top Skills', 'Languages', 'Certifications', 'Licenses', 'Publications'
            ];

            const locationPattern = /^[A-Z][a-zA-Z\s]+,\s*(Germany|France|Spain|Italy|Netherlands|Belgium|Switzerland|Austria|Canada|USA|United States|Australia|UK|United Kingdom|India|China|Japan|Singapore|Brazil|Mexico|California|New York|Texas|Florida|Area|Region|Metropolitan|Greater)/i;

            let nameEndBoundary = Math.min(
                contactIdx > 0 ? contactIdx : 50,
                summaryIdx > 0 ? summaryIdx : 50,
                expIdx > 0 ? expIdx : 50,
                30
            );

            for (let i = 0; i < nameEndBoundary; i++) {
                const line = lines[i];
                if (line.length < 3 || line.length > 60) continue;
                if (sectionHeaders.includes(line)) continue;

                if (locationPattern.test(line)) {
                    data.location = line;
                    continue;
                }

                if (line.includes('@') || line.includes('www.') || line.includes('http')) continue;
                if (line.match(/^\d+\s*(connections|followers)/i)) continue;

                const words = line.split(/\s+/);
                if (words.length >= 2 && words.length <= 5) {
                    const looksLikeName = words.every(w => {
                        if (!w[0]) return false;
                        if (w.match(/^(Jr\.?|Sr\.?|II|III|IV|V)$/i)) return true;
                        return w[0] === w[0].toUpperCase() && !w.match(/^\d+$/);
                    });
                    const noNumbers = !line.match(/\d{2,}/);

                    if (looksLikeName && noNumbers) {
                        data.full_name = line;
                        data.first_name = words[0];
                        data.last_name = words.slice(1).join(' ');

                        if (i + 1 < lines.length) {
                            const nextLine = lines[i + 1];
                            if (!locationPattern.test(nextLine)) {
                                data.headline = nextLine;
                                if (data.headline.includes(' at ')) {
                                    const parts = data.headline.split(' at ');
                                    data.title = parts[0].trim();
                                    data.company = parts[1].split('|')[0].trim();
                                } else if (data.headline.includes(' - ')) {
                                    const parts = data.headline.split(' - ');
                                    data.title = parts[0].trim();
                                    data.company = parts[1].split('|')[0].trim();
                                }
                            }
                        }

                        for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                            const locLine = lines[j];
                            if (locLine === 'Summary' || locLine === 'Experience' || locLine === 'Contact') break;
                            if (locationPattern.test(locLine)) {
                                data.location = locLine;
                                break;
                            }
                        }
                        break;
                    }
                }
            }

            // Experience
            if (expIdx > -1) {
                const jobs = [];
                const endIdx = eduIdx > expIdx ? eduIdx : lines.length;
                for (let i = expIdx + 1; i < endIdx && jobs.length < 10; i++) {
                    const line = lines[i];
                    const dateMatch = line.match(/(\w+\s+)?(\d{4})\s*[-â€“]\s*(Present|\w+\s+\d{4}|\d{4})/);
                    if (dateMatch) {
                        let company = lines[i - 2] || '';
                        let title = lines[i - 1] || '';
                        if (company && !['Experience', 'Page', ''].includes(company)) {
                            jobs.push(`${title} @ ${company}`);
                        }
                    }
                }
                data.experience = jobs.slice(0, 3).join(' | ');
            }

            // Education
            if (eduIdx > -1) {
                const schools = [];
                for (let i = eduIdx + 1; i < Math.min(eduIdx + 15, lines.length); i++) {
                    const line = lines[i];
                    if (['Skills', 'Certifications', 'Languages'].includes(line)) break;
                    if (line.includes('University') || line.includes('College') || line.includes('Institute')) {
                        schools.push(line);
                    }
                }
                data.school = schools.slice(0, 2).join(' | ');
            }

            // Skills
            if (skillsIdx > -1) {
                const skills = [];
                for (let i = skillsIdx + 1; i < Math.min(skillsIdx + 8, lines.length); i++) {
                    const line = lines[i];
                    if (sectionHeaders.includes(line)) break;
                    if (line.length > 2 && line.length < 40) skills.push(line);
                }
                data.skills = skills.join(', ');
            }

            return data;
        }

        function addResultRow(data) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.full_name || 'Unknown'}</td>
                <td>${data.title || '-'}</td>
                <td>${data.company || '-'}</td>
                <td><span class="badge success">Ready</span></td>
            `;
            resultsBody.insertBefore(row, resultsBody.firstChild);
        }

        function downloadCSV() {
            if (profiles.length === 0) return;

            const headers = [
                'First Name', 'Last Name', 'Full Name', 'LinkedIn URL', 'Headline',
                'Title', 'Company', 'Location', 'School', 'Degree',
                'Skills', 'Experience'
            ];

            const rows = profiles.map(p => [
                p.first_name || '',
                p.last_name || '',
                p.full_name || '',
                p.linkedin_link || '',
                p.headline || '',
                p.title || '',
                p.company || '',
                p.location || '',
                p.school || '',
                p.degree || '',
                p.skills || '',
                p.experience || ''
            ]);

            // Escape CSV values
            const escapeCSV = (val) => {
                if (!val) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(escapeCSV).join(','))
            ].join('\n');

            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `linkedin-profiles-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showStatus(`Downloaded ${profiles.length} profiles as CSV`, 'success');
        }

        function clearAll() {
            profiles = [];
            localStorage.removeItem(STORAGE_KEY);
            resultsBody.innerHTML = '';
            resultsSection.classList.remove('visible');
            updateUI();
            showStatus('All profiles cleared', 'info');
        }

        function showStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status visible ${type}`;
            setTimeout(() => {
                statusEl.classList.remove('visible');
            }, 5000);
        }
    </script>
</body>
</html>
